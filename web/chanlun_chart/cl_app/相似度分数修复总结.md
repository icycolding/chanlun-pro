# æ–°é—»å‘é‡æ•°æ®åº“ç›¸ä¼¼åº¦åˆ†æ•°ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

åœ¨æ–°é—»å‘é‡æ•°æ®åº“çš„å—åŒ–æ”¹é€ å®ŒæˆåŽï¼Œå‘çŽ°æ‰€æœ‰è¯­ä¹‰æœç´¢è¿”å›žçš„ç›¸ä¼¼åº¦åˆ†æ•°éƒ½æ˜¯ 0.0000ï¼Œè¿™è¡¨æ˜Ž ChromaDB çš„è·ç¦»è®¡ç®—å­˜åœ¨é—®é¢˜ã€‚

## é—®é¢˜åˆ†æž

### 1. åˆå§‹å‡è®¾
æœ€åˆè®¤ä¸ºé—®é¢˜å¯èƒ½æ˜¯ï¼š
- ChromaDB ä½¿ç”¨ä½™å¼¦è·ç¦»ï¼Œéœ€è¦ç‰¹æ®Šçš„ç›¸ä¼¼åº¦è®¡ç®—æ–¹å¼
- åµŒå…¥å‘é‡ç”Ÿæˆæœ‰é—®é¢˜
- è·ç¦»è½¬æ¢å…¬å¼é”™è¯¯

### 2. è°ƒè¯•è¿‡ç¨‹

#### æ­¥éª¤1ï¼šæ£€æŸ¥åµŒå…¥å‘é‡ç”Ÿæˆ
- åˆ›å»º `debug_embeddings.py` è„šæœ¬
- éªŒè¯åµŒå…¥æ¨¡åž‹æ­£å¸¸å·¥ä½œ
- ç¡®è®¤å‘é‡ç”Ÿæˆå’Œå­˜å‚¨è¿‡ç¨‹æ­£ç¡®

#### æ­¥éª¤2ï¼šæ£€æŸ¥ChromaDBè·ç¦»è®¡ç®—
- ç›´æŽ¥æŸ¥è¯¢ ChromaDB å‘çŽ°è¿”å›žè·ç¦»å€¼ä¸º 6.032607ï¼ˆéž0ï¼‰
- ç¡®è®¤é—®é¢˜åœ¨äºŽè·ç¦»åˆ°ç›¸ä¼¼åº¦çš„è½¬æ¢é€»è¾‘

#### æ­¥éª¤3ï¼šåˆ†æžè·ç¦»ç±»åž‹
- å‘çŽ° ChromaDB é»˜è®¤ä½¿ç”¨ **å¹³æ–¹æ¬§å‡ é‡Œå¾—è·ç¦»**ï¼Œä¸æ˜¯ä½™å¼¦è·ç¦»
- è·ç¦»å€¼èŒƒå›´ä¸æ˜¯ 0-2ï¼Œè€Œæ˜¯æ›´å¤§çš„æ­£æ•°èŒƒå›´

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ­£ç›¸ä¼¼åº¦è®¡ç®—å…¬å¼

**åŽŸå§‹é”™è¯¯å…¬å¼ï¼š**
```python
# å‡è®¾ä½¿ç”¨ä½™å¼¦è·ç¦»çš„é”™è¯¯è®¡ç®—
score = max(0.0, 1.0 - distance / 2.0)
```

**ä¿®æ­£åŽçš„å…¬å¼ï¼š**
```python
# é€‚ç”¨äºŽå¹³æ–¹æ¬§å‡ é‡Œå¾—è·ç¦»çš„æ­£ç¡®è®¡ç®—
score = 1.0 / (1.0 + distance)
```

### 2. ä¿®å¤ä½ç½®

åœ¨ `news_vector_db.py` çš„ `_merge_chunks_by_news_id` æ–¹æ³•ä¸­ï¼š

```python
# è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°ï¼ˆè·ç¦»è¶Šå°ï¼Œç›¸ä¼¼åº¦è¶Šé«˜ï¼‰
score = 1.0 / (1.0 + distance)
```

### 3. å…¶ä»–ç›¸å…³ä¿®å¤

#### ä¿®å¤ `get_similar_news` æ–¹æ³•
- **é—®é¢˜**ï¼šè¯•å›¾é€šè¿‡ `news_id` ç›´æŽ¥èŽ·å–æ–‡æ¡£ï¼Œä½†å®žé™…å­˜å‚¨çš„æ˜¯å—ID
- **è§£å†³**ï¼šé€šè¿‡ metadata æŸ¥æ‰¾æ–°é—»çš„æ‰€æœ‰å—ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå—è¿›è¡Œç›¸ä¼¼æ€§æœç´¢

#### ä¿®å¤ `get_market_relevant_news` æ–¹æ³•
- **é—®é¢˜**ï¼šè¿”å›žåŽŸå§‹å—æ•°æ®ï¼Œæ ¼å¼ä¸ä¸€è‡´
- **è§£å†³**ï¼šä½¿ç”¨ `_merge_chunks_by_news_id` æ–¹æ³•åˆå¹¶å—æ•°æ®ï¼Œè¿”å›žç»Ÿä¸€æ ¼å¼

## æµ‹è¯•éªŒè¯

### 1. åˆ›å»ºæµ‹è¯•è„šæœ¬
- `test_fixed_similarity.py`ï¼šå…¨é¢æµ‹è¯•ä¿®å¤åŽçš„åŠŸèƒ½
- åŒ…å«è¯­ä¹‰æœç´¢ã€ç›¸ä¼¼æ–°é—»æŸ¥æ‰¾ã€å¸‚åœºç›¸å…³æ–°é—»ç­‰æµ‹è¯•

### 2. æµ‹è¯•ç»“æžœ

**è¯­ä¹‰æœç´¢ç›¸ä¼¼åº¦åˆ†æ•°ï¼š**
- ç¾Žè”å‚¨åŠ æ¯æ”¿ç­–ï¼š0.1210 âœ“
- æ¬§æ´²å¤®è¡Œåˆ©çŽ‡å†³è®®ï¼š0.1184 âœ“
- äººå·¥æ™ºèƒ½ç§‘æŠ€è‚¡ï¼š0.0916 âœ“
- é€šèƒ€æŽ§åˆ¶è´§å¸æ”¿ç­–ï¼š0.1210 âœ“

**ç›¸ä¼¼æ–°é—»æŸ¥æ‰¾ï¼š**
- æˆåŠŸæ‰¾åˆ°ç›¸ä¼¼æ–°é—»ï¼Œåˆ†æ•°èŒƒå›´ 0.0925-0.1130 âœ“

**åŠŸèƒ½å®Œæ•´æ€§ï¼š**
- æ–°é—»æ·»åŠ ï¼šâœ“
- è¯­ä¹‰æœç´¢ï¼šâœ“
- ç›¸ä¼¼æ–°é—»æŸ¥æ‰¾ï¼šâœ“
- æ–°é—»åˆ é™¤ï¼šâœ“
- æ•°æ®åº“ç»Ÿè®¡ï¼šâœ“

## æŠ€æœ¯è¦ç‚¹

### 1. ChromaDB è·ç¦»ç±»åž‹
- **é»˜è®¤è·ç¦»**ï¼šå¹³æ–¹æ¬§å‡ é‡Œå¾—è·ç¦»ï¼ˆSquared Euclidean Distanceï¼‰
- **è·ç¦»èŒƒå›´**ï¼š[0, +âˆž)ï¼Œ0è¡¨ç¤ºå®Œå…¨ç›¸åŒ
- **ç‰¹ç‚¹**ï¼šè·ç¦»è¶Šå°ï¼Œç›¸ä¼¼åº¦è¶Šé«˜

### 2. ç›¸ä¼¼åº¦è½¬æ¢åŽŸç†
```python
# ä½¿ç”¨å€’æ•°å‡½æ•°å°†è·ç¦»è½¬æ¢ä¸ºç›¸ä¼¼åº¦
similarity = 1 / (1 + distance)

# ç‰¹æ€§ï¼š
# - å½“ distance = 0 æ—¶ï¼Œsimilarity = 1.0 (å®Œå…¨ç›¸ä¼¼)
# - å½“ distance â†’ âˆž æ—¶ï¼Œsimilarity â†’ 0.0 (å®Œå…¨ä¸ç›¸ä¼¼)
# - ç›¸ä¼¼åº¦èŒƒå›´ï¼š(0, 1]
```

### 3. åˆ†æ•°ç­‰çº§åˆ’åˆ†
- **é«˜ç›¸ä¼¼åº¦**ï¼š> 0.15
- **ä¸­ç­‰ç›¸ä¼¼åº¦**ï¼š0.10 - 0.15
- **ä½Žç›¸ä¼¼åº¦**ï¼š< 0.10

## æ€§èƒ½å½±å“

### 1. è®¡ç®—å¤æ‚åº¦
- ç›¸ä¼¼åº¦è®¡ç®—ï¼šO(1)
- å¯¹æ•´ä½“æ€§èƒ½å½±å“ï¼šå¾®ä¹Žå…¶å¾®

### 2. å‡†ç¡®æ€§æå‡
- ç›¸ä¼¼åº¦åˆ†æ•°çŽ°åœ¨èƒ½æ­£ç¡®åæ˜ æ–‡æ¡£é—´çš„è¯­ä¹‰ç›¸ä¼¼æ€§
- æœç´¢ç»“æžœæŽ’åºæ›´åŠ å‡†ç¡®

## åŽç»­ä¼˜åŒ–å»ºè®®

### 1. è·ç¦»å‡½æ•°ä¼˜åŒ–
- è€ƒè™‘ä½¿ç”¨ä½™å¼¦è·ç¦»ä»¥èŽ·å¾—æ›´å¥½çš„è¯­ä¹‰ç›¸ä¼¼æ€§
- éœ€è¦åœ¨åˆ›å»ºé›†åˆæ—¶æŒ‡å®šï¼š`distance_function="cosine"`

### 2. ç›¸ä¼¼åº¦é˜ˆå€¼è°ƒä¼˜
- æ ¹æ®å®žé™…ä½¿ç”¨æƒ…å†µè°ƒæ•´ç›¸ä¼¼åº¦ç­‰çº§åˆ’åˆ†
- ä¸ºä¸åŒåº”ç”¨åœºæ™¯è®¾ç½®ä¸åŒçš„ç›¸ä¼¼åº¦é˜ˆå€¼

### 3. æ€§èƒ½ç›‘æŽ§
- æ·»åŠ ç›¸ä¼¼åº¦åˆ†æ•°çš„ç»Ÿè®¡å’Œç›‘æŽ§
- å®šæœŸè¯„ä¼°æœç´¢è´¨é‡

## æ€»ç»“

âœ… **ä¿®å¤æˆåŠŸ**ï¼šç›¸ä¼¼åº¦åˆ†æ•°ä»Ž 0.0000 ä¿®å¤ä¸ºæ­£ç¡®çš„æ•°å€¼èŒƒå›´ï¼ˆ0.0916-0.1210ï¼‰

ðŸ”§ **æ ¸å¿ƒä¿®å¤**ï¼šå°†è·ç¦»è½¬æ¢å…¬å¼ä»Ž `1.0 - distance/2.0` æ”¹ä¸º `1.0/(1.0 + distance)`

ðŸ“Š **åŠŸèƒ½å®Œæ•´**ï¼šæ‰€æœ‰æ–°é—»å‘é‡æ•°æ®åº“åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬å—åŒ–å­˜å‚¨ã€è¯­ä¹‰æœç´¢ã€ç›¸ä¼¼æ–°é—»æŸ¥æ‰¾ç­‰

ðŸš€ **æ€§èƒ½æå‡**ï¼šæœç´¢ç»“æžœçŽ°åœ¨èƒ½å¤Ÿæ­£ç¡®æŒ‰ç›¸ä¼¼åº¦æŽ’åºï¼Œæä¾›æ›´å‡†ç¡®çš„è¯­ä¹‰åŒ¹é…

---

**ä¿®å¤æ—¥æœŸ**ï¼š2024å¹´1æœˆ
**å½±å“èŒƒå›´**ï¼šæ–°é—»å‘é‡æ•°æ®åº“çš„æ‰€æœ‰ç›¸ä¼¼åº¦è®¡ç®—åŠŸèƒ½
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… é€šè¿‡å®Œæ•´åŠŸèƒ½æµ‹è¯•