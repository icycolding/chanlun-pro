<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>缠论解盘 - TradingView Chart</title>

    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='favicon.ico') }}" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/layui.css') }}" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/app.css') }}" />

    <script
      type="text/javascript"
      src="{{ url_for('static', filename='jquery-3.7.0.min.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='layui.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='xm-select.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='marked.min.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='charting_library/charting_library.standalone.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='datafeeds/udf/dist/bundle.js') }}"></script>
    {% include 'dark.html' %}
  </head>

  <body>
    <div class="layui-fluid" style="padding: 0; height: 100vh; display: flex; flex-direction: column;">
      <div class="layui-row" style="flex: 3; min-height: 0;">
        <div
          class="layui-col-xs10 layui-col-sm10 layui-col-md10"
          id="chart_container"
          style="display: flex; flex-direction: column; height: 100%;">
          {# 图表内容 #}
          <div
            id="tv_charts_area"
            style="
              width: 100%;
              height: 100%;
              display: flex;
              flex-direction: column;
            "></div>
        </div>
        <div
          class="layui-col-xs2 layui-col-sm2 layui-col-md2"
          id="chart_menu"
          style="
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            overflow: scroll;
            padding: 0;
            margin: 0;
          ">
          <div style="padding: 10px">
            <div class="layui-inline" style="width: 100%">
              <h2 style="float: left; margin-top: 9px">缠论解盘</h2>
              <div
                id="toggle-menu"
                style="float: right; margin-top: 10px; cursor: pointer">
                <div>
                  <i class="layui-icon layui-icon-shrink-right"></i>
                </div>
              </div>
            </div>
            <hr class="layui-border-red" />
            <form
              class="layui-form layui-form-pane"
              lay-filter="select_market_form">
              <div class="layui-form-item">
                <div class="layui-input-block" style="margin: 0; padding: 0">
                  <label>
                    <select name="market" lay-filter="select_market">
                      <option value="a">沪深A股</option>
                      <option value="hk">港股</option>
                      <option value="futures">国内期货</option>
                      <option value="ny_futures">纽约期货</option>
                      <option value="fx">外汇</option>
                      <option value="us">美股</option>
                      <option value="currency">数字货币(合约)</option>
                      <option value="currency_spot">数字货币(现货)</option>
                    </select>
                  </label>
                </div>
              </div>
              <div class="layui-form-item">
                <div id="code_search" class="xm-select-demo"></div>
              </div>
            </form>
          </div>
          <div class="layui-collapse lay-accordion" lay-filter="collapse-opts">
            <div class="layui-colla-item">
              {# 自选内容 #}
              <div class="layui-colla-title" data-ca-title="自选组">自选组</div>
              <div
                class="layui-colla-content layui-show"
                style="padding: 0; position: relative; height: 100%">
                <form
                  class="layui-form zixuan-form-bg"
                  style="
                    width: 100%;
                    position: sticky;
                    top: 0;
                    z-index: 10;
                    padding: 5px 0;
                  ">
                  <div class="layui-form-item">
                    <div class="layui-inline">
                      <div
                        class="layui-input-inline layui-input-wrap"
                        style="width: 60%; float: left">
                        <label for="zixuan_groups">
                          <select
                            id="zixuan_groups"
                            name="zixuan_groups"
                            lay-filter="select_zx_group"></select>
                        </label>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="add_zixuan"
                          class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                          <i class="layui-icon layui-icon-add-1"></i> 自选
                        </button>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="refresh_zixuan"
                          class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                          <i class="layui-icon layui-icon-refresh"></i>
                        </button>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="history_market_summary_btn"
                          class="layui-btn layui-btn-primary layui-border-blue layui-btn-sm"
                          onclick="window.open('/market_summary', '_blank')">
                          <i class="layui-icon layui-icon-chart"></i> 历史报告
                        </button>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">

                      </div>
                    </div>
                  </div>
                </form>
                <div
                  style="
                    overflow-y: auto;
                    height: calc(100% - 50px);
                    margin-top: 5px;
                  ">
                  <table
                    class="layui-hide"
                    id="table_zixuan_list"
                    style="width: 100%"></table>
                </div>
                <hr class="layui-border-red" />
              </div>
            </div>

            <div class="layui-colla-item">
              <div class="layui-colla-title" data-ca-title="监控提醒">
                监控提醒
              </div>
              <div class="layui-colla-content" style="padding: 0">
                <form
                  class="layui-form"
                  lay-filter="alert_records_form"
                  style="padding: 10px 10px 0 10px">
                  <div class="layui-form-item">
                    <label class="layui-form-label">任务名称</label>
                    <div class="layui-input-block">
                      <select
                        name="task_name_select"
                        id="task_name_select"
                        lay-filter="task_name_select">
                        <option value="">全部</option>
                      </select>
                    </div>
                  </div>
                </form>
                <table
                  class="layui-hide"
                  id="table_alert_reocrds"
                  lay-filter="table_alert_reocrds"></table>
                <hr class="layui-border-red" />
              </div>
            </div>
            <div class="layui-colla-item" id="collapse-bkgn">
              <div class="layui-colla-title" data-ca-title="板块概念">
                板块概念
              </div>
              <div class="layui-colla-content" style="padding: 0">
                <form
                  class="layui-form"
                  lay-filter="bkgn_form"
                  style="padding: 10px 10px 0 10px">
                  <div class="layui-form-item" style="margin-bottom: 5px">
                    <div class="layui-input-inline" style="width: 100%">
                      <div id="bkgn_xm_select"></div>
                    </div>
                  </div>
                </form>
                <div style="padding: 10px">
                  <table
                    class="layui-hide"
                    id="bkgn_table"
                    lay-filter="bkgn_table"
                    style="width: 100%; display: none"></table>
                </div>
                <hr class="layui-border-red" />
              </div>
            </div>
            <div class="layui-colla-item">
              <div class="layui-colla-title" data-ca-title="AI分析助手">
                AI分析助手
              </div>
              <div class="layui-colla-content" style="padding: 0">
                <form class="layui-form" style="width: 100%">
                  <div class="layui-form-item">
                    <div class="layui-inline">
                      <div
                        class="layui-input-inline layui-input-wrap"
                        style="width: 40%; float: left">
                        <label for="ai_code">
                          <input
                            type="text"
                            name="ai_code"
                            id="ai_code"
                            autocomplete="off"
                            readonly="readonly"
                            class="layui-input" />
                        </label>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="width: 30%; padding: 0 !important; float: left">
                        <label>
                          <select
                            name="ai_frequencys"
                            id="ai_frequencys"></select>
                        </label>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="ai_analyse_btn"
                          class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                          分析
                        </button>
                      </div>
                    </div>
                  </div>
                </form>
                <table
                  class="layui-hide"
                  id="table_ai_analysis"
                  lay-filter="table_ai_analysis"></table>

                <hr class="layui-border-red" />
              </div>
            </div>
            <div class="layui-colla-item">
              <div class="layui-colla-title" data-ca-title="关于">关于</div>
              <div class="layui-colla-content" style="padding: 0">
                <div class="layui-text" style="padding: 16px">
                  <h3>Chanlun-Pro</h3>
                  <p>基于缠论的市场行情量化分析工具</p>
                  <p>
                    <a
                      href="https://github.com/yijixiuxin/chanlun-pro"
                      target="_blank"
                      >Github 地址</a
                    >
                    <a
                      href="https://gitee.com/wang-student/chanlun-pro"
                      target="_blank"
                      >Gitee 地址</a
                    >
                  </p>
                  <p>
                    项目文档：<a
                      href="https://chanlun-pro.readthedocs.io/"
                      target="_blank"
                      >链接</a
                    >
                  </p>
                  <p>
                    项目作者<br />
                    <img
                      src="{{ url_for('static', filename='imgs/wx.jpg') }}"
                      width="200px"
                      height="260px"
                      alt="" />
                  </p>
                </div>

                <hr class="layui-border-red" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 新闻资讯区域 - 占用屏幕底部1/4 -->
      <div class="layui-row" style="flex: 1; min-height: 0; background-color: #f8f8f8; border-top: 1px solid #e6e6e6;">
        <div class="layui-col-xs12" style="height: 100%; padding: 10px;">
          <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h3 id="news_section_title" style="margin: 0; color: #333;">新闻资讯</h3>
              <div style="display: flex; gap: 8px;">
                <button
                  type="button"
                  id="market_summary_btn"
                  class="layui-btn layui-btn-normal layui-btn-sm">
                  <i class="layui-icon layui-icon-chart"></i> 市场总结
                </button>
                <button
                  type="button"
                  id="refresh_news"
                  class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                  <i class="layui-icon layui-icon-refresh"></i> 刷新新闻
                </button>
              </div>
            </div>
            <div
              id="news_list"
              style="
                flex: 1;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #e6e6e6;
                border-radius: 4px;
                padding: 15px;
              ">
              <!-- 新闻列表将通过JavaScript动态加载 -->
              <div class="layui-text" style="text-align: center; color: #999; padding: 20px;">
                点击刷新按钮加载新闻
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% include 'sub_temp.html' %}
  </body>
  <script>
    // 定时更新tick涨跌幅的对象
    var interval_update_rates;
    var interval_get_alert_records;

    var market_frequencys = `{{ market_frequencys| tojson }}`;
    // 解析 json 字符串
    var market_frequencys = JSON.parse(market_frequencys);

    var default_vals = {
      theme: "Light",
      market: "a",
      a_interval_1: "1D",
      a_interval_2: "1D",
      hk_interval_1: "1D",
      hk_interval_2: "1D",
      us_interval_1: "1D",
      us_interval_2: "1D",
      fx_interval_1: "1D",
      fx_interval_2: "1D",
      futures_interval_1: "1D",
      futures_interval_2: "1D",
      ny_futures_interval_1: "1D",
      ny_futures_interval_2: "1D",
      currency_interval_1: "1D",
      currency_interval_2: "1D",
      currency_spot_interval_1: "1D",
      currency_spot_interval_2: "1D",
      chart_layout_type: "single",
      a_code: "{{ market_default_codes.a }}",
      hk_code: "{{ market_default_codes.hk }}",
      us_code: "{{ market_default_codes.us }}",
      fx_code: "{{ market_default_codes.fx }}",
      futures_code: "{{ market_default_codes.futures }}",
      ny_futures_code: "{{ market_default_codes.ny_futures }}",
      currency_code: "{{ market_default_codes.currency }}",
      currency_spot_code: "{{ market_default_codes.currency_spot }}",
    };
    

    var chart_widgets = [];

    // 变更图表展示的标的
    function change_chart_ticker(_market, _code) {
      var market = _market;
      var code = _code;
      console.log('code',code)
      Utils.set_local_data("market", market);
      Utils.set_local_data(market + "_code", code);
      layui.each(chart_widgets, function (i, w) {
        w.activeChart().setSymbol(market + ":" + code);
      });
      ZiXuan.render_zixuan_opts();
      
      // 根据股票代码搜索相关新闻
      search_news_by_code(market, code);
    }
    
    // 根据股票代码搜索相关新闻
    function search_news_by_code(market, code) {
      // 构建搜索查询，包含股票代码和市场信息
      var searchQuery = code;
      if (market === 'a') {
        searchQuery += ' 股票 A股';
      } else if (market === 'hk') {
        searchQuery += ' 港股 香港';
      } else if (market === 'us') {
        searchQuery += ' 美股 美国';
      } else if (market === 'currency') {
        searchQuery += ' 外汇 汇率';
      } else if (market === 'futures') {
        searchQuery += ' 期货';
      }
      
      console.log('搜索相关新闻:', searchQuery);
      
      // 发送语义搜索请求
      $.ajax({
        url: '/api/news/semantic_search',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          query: searchQuery,
          n_results: 50,
          filters: {
            market_relevance: {"$gte": 0.3}  // 只显示市场相关度较高的新闻
          }
        }),
        success: function(response) {
           console.log('新闻搜索结果:', response);
           if (response.code === 0 && response.data && response.data.results && response.data.results.length > 0) {
             // 转换搜索结果格式以匹配render_news_list期望的数据结构
             var formattedNews = response.data.results.map(function(item) {
               var metadata = item.metadata || {};
               return {
                 news_id: metadata.news_id || item.id,
                 title: metadata.title || '无标题',
                 published_at: metadata.published_at || metadata.timestamp,
                 source: metadata.source || '未知来源',
                 body: item.document || metadata.body || ''
               };
             });
             
             // 渲染搜索到的新闻
             News.render_news_list(formattedNews);
             // 更新新闻区域标题，显示当前搜索的股票
             $('#news_section_title').text('新闻资讯 - ' + code + ' 相关');
           } else {
             console.log('未找到相关新闻，加载默认新闻');
             // 如果没有找到相关新闻，加载默认新闻
             News.load_news();
             $('#news_section_title').text('新闻资讯');
           }
         },
        error: function(xhr, status, error) {
          console.error('搜索新闻失败:', error);
          // 搜索失败时加载默认新闻
          News.load_news();
          $('#news_section_title').text('新闻资讯');
        }
      });
    }
  </script>
  <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/chart_idx.js') }}"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
  <script src="{{ url_for('static', filename='js/zixuan.js') }}"></script>
  <script src="{{ url_for('static', filename='js/alert.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bkgn.js') }}"></script>
  <script>
    $(function () {
      // 处理URL参数
      function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const market = urlParams.get('market');
        const code = urlParams.get('code');
        
        if (market && code) {
          console.log('URL参数检测到:', 'market=' + market, 'code=' + code);
          // 设置市场和代码到localStorage
          Utils.set_local_data('market', market);
          Utils.set_local_data(market + '_code', code);
          
          // 更新表单选择
          setTimeout(function() {
            layui.use('form', function() {
              var form = layui.form;
              form.val('select_market_form', {
                market: market
              });
            });
          }, 100);
        }
      }
      
      // 页面加载时处理URL参数
      handleUrlParams();
      
      // 缠论配置项更改
      layui.use(function () {
        var layer = layui.layer;
        var element = layui.element;
        var form = layui.form;
        var util = layui.util;
        var dropdown = layui.dropdown;

        // 下拉菜单事件
        dropdown.render({
          elem: "#toggle-menu",
          data: [
            {
              title: "缠论配置项",
              templet:
                '<div><i class="layui-icon layui-icon-set"></i> <span>缠论配置项</span></div>',
              id: 1,
            },
            {
              title: "自选组管理",
              templet:
                '<div><i class="layui-icon layui-icon-templeate-1"></i> <span>自选组管理</span></div>',
              id: 2,
            },
            {
              title: "监控列表",
              templet:
                '<div><i class="layui-icon layui-icon-list"></i> <span>监控列表</span></div>',
              id: 3,
            },
            {
              title: "新增监控",
              templet:
                '<div><i class="layui-icon layui-icon-speaker"></i> <span>新增监控</span></div>',
              id: 4,
            },
            {
              title: "当前任务",
              templet:
                '<div><i class="layui-icon layui-icon-senior"></i> <span>当前任务</span></div>',
              id: 6,
            },
            {
              title: "切换图表布局",
              templet:
                '<div><i class="layui-icon layui-icon-carousel"></i> <span>切换图表布局</span></div>',
              id: 7,
              child: [
                {
                  title: "布局-单图",
                  id: "single",
                },
                {
                  title: "布局-横向双图",
                  id: "horizontal-2",
                },
                {
                  title: "布局-横向7/3",
                  id: "horizontal-7-3",
                },
                {
                  title: "布局-纵向双图",
                  id: "vertical-2",
                },
                {
                  title: "布局-三图",
                  id: "three",
                },
                {
                  title: "布局-四图",
                  id: "four",
                },
              ],
            },
            {
              title: "切换主题",
              templet:
                '<div><i class="layui-icon layui-icon-engine"></i> <span>切换主题</span></div>',
              id: 8,
            },
          ],
          click: function (item) {
            if (item.title === "缠论配置项") {
              layer.open({
                type: 2,
                title: "缠论配置项变更",
                area: ["1100px", "90vh"],
                content:
                  "/get_cl_config/" +
                  Utils.get_market() +
                  "/" +
                  Utils.get_code().replace("/", "__"),
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
              });
            } else if (item.title === "自选组管理") {
              layer.open({
                type: 2,
                title: "自选组管理",
                area: ["800px", "50vh"],
                content: "/zixuan_group/" + Utils.get_market(),
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
              });
            } else if (item.title === "监控列表") {
              layer.open({
                type: 1,
                title: "监控列表",
                area: ["1000px", "50vh"],
                content: $("#layer-wrapper-alert-task-list"),
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
                btn: ["刷新"],
                btn1: function (index, layero, that) {
                  Alert.refresh_alerts_table();
                },
                success: function (layero, index, that) {
                  // 初始渲染表格
                  if (typeof Alert.refresh_alerts_table === "function") {
                    Alert.refresh_alerts_table();
                  }
                },
                end: function () {
                  $("#layer-wrapper-alert-task-list").hide();
                },
              });
            } else if (item.title === "新增监控") {
              layer.open({
                type: 2,
                title: "新增监控提醒",
                area: ["1000px", "90vh"],
                content: "/alert_edit/" + Utils.get_market() + "/0",
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
              });
            } else if (item.title === "运行选股") {
              layer.open({
                type: 2,
                title: "运行选股",
                area: ["1000px", "50vh"],
                content: "/xuangu/task_list/" + Utils.get_market(),
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
              });
            } else if (item.title === "当前任务") {
              layer.open({
                type: 2,
                title: "当前任务",
                area: ["1000px", "50vh"],
                content: "/jobs",
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
              });
            } else if (item.title.startsWith("布局-")) {
              Utils.set_local_data("chart_layout_type", item.id);
              location.reload();
            } else if (item.title === "切换主题") {
              let theme = Utils.get_local_data("theme");
              if (theme === "Light") {
                Utils.set_local_data("theme", "dark");
              } else {
                Utils.set_local_data("theme", "Light");
              }
              location.reload();
            } else if (item.title === "系统设置") {
              layer.open({
                type: 2,
                title: "系统设置",
                area: ["1000px", "50vh"],
                content: "/setting",
                anim: 1,
                fixed: true, // 不固定
                shadeClose: true,
              });
            }
          },
        });

        // 自选操作初始
        ZiXuan.init_zixuan_opts();

        // 折叠面板事件
        element.on("collapse(collapse-opts)", function (data) {
          let is_open = data.show; // 得到当前面板的展开状态，true or false
          let ca_title = $(data.title).attr("data-ca-title"); // 得到当前点击面板的标题区域对象

          if (ca_title === "自选组") {
            if (is_open) {
              interval_update_rates = setInterval(
                ZiXuan.stocks_update_rate(),
                30000
              );
            } else {
              clearInterval(interval_update_rates);
            }
          }
          if (ca_title === "监控提醒") {
            if (is_open) {
              Alert.init();
              // 获取警报记录
              Alert.get_alert_records();
              interval_get_alert_records = setInterval(
                Alert.get_alert_records,
                60000
              );
            } else {
              clearInterval(interval_get_alert_records);
            }
          }



          if (ca_title === "板块概念") {
            if (is_open) {
              // 板块概念
              BKGN.init_bkgn_opts();
            }
          }
        });

        // 初始赋值
        form.val("select_market_form", {
          market: Utils.get_market(),
        });
        // 表单变动
        form.on("select(select_market)", function (data) {
          var market = data.value;
          Utils.set_local_data("market", market);
          // 保持URL参数进行刷新
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('market') || urlParams.has('code')) {
            urlParams.set('market', market);
            window.location.href = window.location.pathname + '?' + urlParams.toString();
          } else {
            location.reload();
          }
        });

        // 固定条，显示与隐藏菜单栏
        Utils.render_fixbar();

        // AI 分析助手
        AI.init_ai_opts();
        AI.get_ai_analyse_records();

        // 新闻模块初始化
        News.init();
        // 自动加载新闻数据
        News.load_news();
      });

      // 初始化展示页面
      function init_web() {
        // 如果市场不是 a，则隐藏 collapse-bkgn
        if (Utils.get_market() !== "a") {
          $("#collapse-bkgn").hide();
        }

        let chart_layout_type =
          Utils.get_local_data("chart_layout_type") || "single";
        let charts_area = $("#tv_charts_area");
        charts_area.empty();
        let win_height = window.innerHeight;
        let win_width = charts_area.width() || window.innerWidth;
        let chart_configs = [];
        if (chart_layout_type === "single") {
          chart_configs = [{ id: "1", style: "flex:1;" }];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "vertical-2") {
          chart_configs = [
            { id: "1", style: "flex:1;" },
            { id: "2", style: "flex:1;" },
          ];
          charts_area.css({ display: "flex", flexDirection: "row" });
        } else if (chart_layout_type === "horizontal-2") {
          chart_configs = [
            { id: "1", style: "flex:1;" },
            { id: "2", style: "flex:1;" },
          ];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "three") {
          chart_configs = [{ id: "1" }, { id: "2" }, { id: "3" }];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "horizontal-7-3") {
          chart_configs = [{ id: "1" }, { id: "2" }];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "four") {
          chart_configs = [
            { id: "1", style: "width:50%;height:50%;float:left;" },
            { id: "2", style: "width:50%;height:50%;float:left;" },
            { id: "3", style: "width:50%;height:50%;float:left;" },
            { id: "4", style: "width:50%;height:50%;float:left;" },
          ];
          charts_area.css({
            display: "flex",
            flexDirection: "row",
            flexWrap: "wrap",
          });
        }

        chart_widgets = [];
        if (chart_layout_type === "horizontal-7-3") {
          charts_area.append(
            '<div id="tv_chart_container_1" style="width:100%;height:' +
              win_height * 0.7 +
              'px;"></div>'
          );
          charts_area.append(
            '<div id="tv_chart_container_2" style="width:100%;height:' +
              win_height * 0.3 +
              'px;"></div>'
          );
          chart_widgets.push(Charts.show_tv_chart("1", win_height * 0.7));
          chart_widgets.push(Charts.show_tv_chart("2", win_height * 0.3));
        } else if (chart_layout_type === "three") {
          // 上面一行两个图
          let rowDiv = $(
            '<div style="display:flex;width:100%;height:' +
              win_height / 2 +
              'px;"></div>'
          );
          rowDiv.append(
            '<div id="tv_chart_container_1" style="flex:1;"></div>'
          );
          rowDiv.append(
            '<div id="tv_chart_container_2" style="flex:1;"></div>'
          );
          charts_area.append(rowDiv);
          // 下面一行一个图
          charts_area.append(
            '<div id="tv_chart_container_3" style="width:100%;height:' +
              win_height / 2 +
              'px;"></div>'
          );
          chart_widgets.push(Charts.show_tv_chart("1", win_height / 2));
          chart_widgets.push(Charts.show_tv_chart("2", win_height / 2));
          chart_widgets.push(Charts.show_tv_chart("3", win_height / 2));
        } else {
          chart_configs.forEach(function (cfg, idx) {
            let div_id = "tv_chart_container_" + cfg.id;
            charts_area.append(
              '<div id="' +
                div_id +
                '" style="' +
                (cfg.style || "") +
                '"></div>'
            );
            // 计算每个图表的高度/宽度
            let chart_height =
              chart_layout_type === "single"
                ? win_height
                : chart_layout_type === "vertical-2" ||
                  chart_layout_type === "horizontal-2"
                ? win_height / 2
                : chart_layout_type === "four"
                ? win_height / 2
                : win_height;
            chart_widgets.push(Charts.show_tv_chart(cfg.id, chart_height));
          });
        }
        ZiXuan.render_zixuan_opts();
      }

      init_web();
      interval_update_rates = setInterval(ZiXuan.stocks_update_rate(), 30000);
    });

    // 新闻模块对象（移到全局作用域）
    window.News = {
      // 初始化
      init: function() {
        var self = this;
        // 绑定刷新按钮事件
        $('#refresh_news').click(function() {
          self.load_news();
        });
        
        // 绑定市场总结按钮事件
        $('#market_summary_btn').click(function() {
          self.generate_market_summary();
        });
      },

      // 加载新闻数据
      load_news: function() {
        var self = this;
        var newsContainer = $('#news_list');
        
        // 显示加载中状态
        newsContainer.html('<div class="layui-text" style="text-align: center; color: #999; padding: 20px;"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 加载中...</div>');
        
        // 发送AJAX请求获取新闻数据
        $.ajax({
          url: '/api/news',
          type: 'GET',
          data: {
            limit: 20,
            offset: 0
          },
          success: function(response) {
            if (response.code === 0 && response.data && response.data.news_list) {
              self.render_news_list(response.data.news_list);
            } else {
              newsContainer.html('<div class="layui-text" style="text-align: center; color: #ff5722; padding: 20px;">加载新闻失败: ' + (response.msg || '未知错误') + '</div>');
            }
          },
          error: function(xhr, status, error) {
            newsContainer.html('<div class="layui-text" style="text-align: center; color: #ff5722; padding: 20px;">网络错误，请稍后重试</div>');
          }
        });
      },

      // 渲染新闻列表
      render_news_list: function(newsList) {
        var self = this;
        var newsContainer = $('#news_list');
        var html = '';
        
        // 存储当前新闻列表数据
        this.currentNewsList = newsList;
        
        if (newsList.length === 0) {
          html = '<div class="layui-text" style="text-align: center; color: #999; padding: 20px;">暂无新闻数据</div>';
        } else {
          newsList.forEach(function(news) {
            // var publishTime = news.published_at ? new Date(news.published_at).toLocaleString('zh-CN', {
            //   month: '2-digit',
            //   day: '2-digit',
            //   hour: '2-digit',
            //   minute: '2-digit'
            // }) : '未知时间';
            publishTime =news.published_at.replace('T',' ').replace('Z','');
            html += '<div class="news-item" style="margin-bottom: 10px; padding: 8px; border: 1px solid #e6e6e6; border-radius: 4px; cursor: pointer;" data-news-id="' + news.news_id + '">';
            html += '<div class="news-title" style="font-size: 12px; font-weight: bold; color: #333; margin-bottom: 4px; line-height: 1.4;" title="' + news.title + '">' + (news.title.length > 50 ? news.title.substring(0, 50) + '...' : news.title) + '</div>';
            html += '<div class="news-meta" style="font-size: 10px; color: #999;">';
            html += '<span class="news-time">' + publishTime + '</span>';
            if (news.source) {
              html += ' | <span class="news-source">' + news.source + '</span>';
            }
            html += '</div>';
            html += '</div>';
          });
        }
        
        newsContainer.html(html);
        
        // 使用事件委托绑定新闻项点击事件
        newsContainer.off('click', '.news-item').on('click', '.news-item', function() {
          var newsId = $(this).data('news-id');
          console.log('News item clicked, ID:', newsId);
          if (self.show_news_detail) {
            self.show_news_detail(newsId);
          } else {
            console.error('News.show_news_detail function not found');
          }
        });
      },

      // 存储当前新闻列表数据
      currentNewsList: [],
      
      // 显示新闻详情
      show_news_detail: function(newsId) {
        console.log('show_news_detail called with newsId:', newsId);
        
        // 首先尝试从当前新闻列表中查找
        var news = this.currentNewsList.find(function(item) {
          return item.news_id === String(newsId) || item.news_id === newsId || item.id === parseInt(newsId) || item.story_id === newsId;
        });
        
        if (news) {
          console.log('Found news in current list:', news);
          this.display_news_detail(news);
        } else {
          console.log('News not found in current list, fetching from API');
          // 如果当前列表中没有，则从API获取
          $.ajax({
            url: '/api/news',
            type: 'GET',
            data: {
              limit: 100,
              offset: 0
            },
            success: function(response) {
              console.log('News detail AJAX success:', response);
              if (response.code === 0 && response.data && response.data.news_list) {
                var foundNews = response.data.news_list.find(function(item) {
                  return item.news_id === String(newsId) || item.news_id === newsId || item.id === parseInt(newsId) || item.story_id === newsId;
                });
                
                if (foundNews) {
                  window.News.display_news_detail(foundNews);
                } else {
                  layui.layer.msg('未找到新闻详情');
                }
              } else {
                layui.layer.msg('获取新闻详情失败');
              }
            },
            error: function(xhr, status, error) {
              console.error('News detail AJAX error:', error);
              layui.layer.msg('网络错误，请稍后重试');
            }
          });
        }
      },
      
      // 显示新闻详情弹窗
      display_news_detail: function(news) {
        var publishTime = news.published_at ? new Date(news.published_at).toLocaleString('zh-CN') : '未知时间';
        var content = '<div style="padding: 20px;">';
        content += '<h3 style="margin-bottom: 15px; color: #333;">' + news.title + '</h3>';
        content += '<div style="margin-bottom: 15px; color: #666; font-size: 12px;">';
        content += '<span>发布时间: ' + publishTime + '</span>';
        if (news.source) {
          content += ' | <span>来源: ' + news.source + '</span>';
        }
        content += '</div>';
        content += '<div style="line-height: 1.6; color: #333;">' + (news.body || '暂无正文内容') + '</div>';
        content += '</div>';
        
        layui.layer.open({
          type: 1,
          title: '新闻详情',
          area: ['80%', '80%'],
          content: content,
          shadeClose: true,
          maxmin: true
        });
      },
      
      // 生成市场总结
      generate_market_summary: function() {
        var self = this;
        
        // 检查是否有新闻数据
        if (!this.currentNewsList || this.currentNewsList.length === 0) {
          layui.layer.msg('请先加载新闻数据');
          return;
        }
        
        // 显示加载提示
        var loadingIndex = layui.layer.load(1, {
          content: '正在生成市场总结，请稍候...',
          success: function(layero) {
            layero.find('.layui-layer-content').css({
              'padding-top': '40px',
              'width': '200px'
            });
          }
        });
        
        // 获取当前标的信息
        var currentMarket = Utils.get_market();
        var currentCode = Utils.get_code();
        
        // 发送请求生成市场总结
        $.ajax({
          url: '/api/news/market_summary',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            news_list: this.currentNewsList,
            current_market: currentMarket,
            current_code: currentCode
          }),
          success: function(response) {
            layui.layer.close(loadingIndex);
            
            if (response.code === 0 && response.data && response.data.summary) {
              self.show_market_summary(response.data.summary);
            } else {
              layui.layer.msg('生成市场总结失败: ' + (response.msg || '未知错误'));
            }
          },
          error: function(xhr, status, error) {
            layui.layer.close(loadingIndex);
            layui.layer.msg('网络错误，请稍后重试');
          }
        });
      },
      
      // 显示市场总结弹窗
      show_market_summary: function(summary) {
        var currentDate = new Date().toLocaleDateString('zh-CN');
        var content = '<div style="padding: 20px;">';
        content += '<div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #333;">📊 ' + currentDate + ' 市场总结</h4>';
        content += '<p style="margin: 0; color: #666; font-size: 12px;">基于当前新闻数据，由AI大模型生成</p>';
        content += '</div>';
        // 使用marked.js将Markdown转换为HTML
        var htmlContent = marked.parse ? marked.parse(summary) : (marked(summary) || summary);
        content += '<div style="line-height: 1.8; color: #333;">' + htmlContent + '</div>';
        content += '</div>';
        
        layui.layer.open({
          type: 1,
          title: '市场总结',
          area: ['85%', '85%'],
          content: content,
          shadeClose: true,
          maxmin: true,
          btn: ['关闭'],
          btnAlign: 'c'
        });
      }
    };
  </script>
</html>
