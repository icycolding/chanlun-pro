<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>ç¼ è®ºè§£ç›˜ - TradingView Chart</title>

    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='favicon.ico') }}" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/layui.css') }}" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/app.css') }}" />

    <script
      type="text/javascript"
      src="{{ url_for('static', filename='jquery-3.7.0.min.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='layui.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='xm-select.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='marked.min.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='charting_library/charting_library.standalone.js') }}"></script>
    <script
      type="text/javascript"
      src="{{ url_for('static', filename='datafeeds/udf/dist/bundle.js') }}"></script>
    {% include 'dark.html' %}
  </head>

  <body>
    <div class="layui-fluid" style="padding: 0; height: 100vh; display: flex; flex-direction: column;">
      <div class="layui-row" style="flex: 3; min-height: 0;">
        <div
          class="layui-col-xs10 layui-col-sm10 layui-col-md10"
          id="chart_container"
          style="display: flex; flex-direction: column; height: 100%;">
          {# å›¾è¡¨å†…å®¹ #}
          <div
            id="tv_charts_area"
            style="
              width: 100%;
              height: 100%;
              display: flex;
              flex-direction: column;
            "></div>
        </div>
        <div
          class="layui-col-xs2 layui-col-sm2 layui-col-md2"
          id="chart_menu"
          style="
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            overflow: scroll;
            padding: 0;
            margin: 0;
          ">
          <div style="padding: 10px">
            <div class="layui-inline" style="width: 100%">
              <h2 style="float: left; margin-top: 9px">ç¼ è®ºè§£ç›˜</h2>
              <div
                id="toggle-menu"
                style="float: right; margin-top: 10px; cursor: pointer">
                <div>
                  <i class="layui-icon layui-icon-shrink-right"></i>
                </div>
              </div>
            </div>
            <hr class="layui-border-red" />
            <form
              class="layui-form layui-form-pane"
              lay-filter="select_market_form">
              <div class="layui-form-item">
                <div class="layui-input-block" style="margin: 0; padding: 0">
                  <label>
                    <select name="market" lay-filter="select_market">
                      <option value="a">æ²ªæ·±Aè‚¡</option>
                      <option value="hk">æ¸¯è‚¡</option>
                      <option value="futures">å›½å†…æœŸè´§</option>
                      <option value="ny_futures">çº½çº¦æœŸè´§</option>
                      <option value="fx">å¤–æ±‡</option>
                      <option value="us">ç¾è‚¡</option>
                      <option value="currency">æ•°å­—è´§å¸(åˆçº¦)</option>
                      <option value="currency_spot">æ•°å­—è´§å¸(ç°è´§)</option>
                    </select>
                  </label>
                </div>
              </div>
              <div class="layui-form-item">
                <div id="code_search" class="xm-select-demo"></div>
              </div>
            </form>
          </div>
          <div class="layui-collapse lay-accordion" lay-filter="collapse-opts">
            <div class="layui-colla-item">
              {# è‡ªé€‰å†…å®¹ #}
              <div class="layui-colla-title" data-ca-title="è‡ªé€‰ç»„">è‡ªé€‰ç»„</div>
              <div
                class="layui-colla-content layui-show"
                style="padding: 0; position: relative; height: 100%">
                <form
                  class="layui-form zixuan-form-bg"
                  style="
                    width: 100%;
                    position: sticky;
                    top: 0;
                    z-index: 10;
                    padding: 5px 0;
                  ">
                  <div class="layui-form-item">
                    <div class="layui-inline">
                      <div
                        class="layui-input-inline layui-input-wrap"
                        style="width: 60%; float: left">
                        <label for="zixuan_groups">
                          <select
                            id="zixuan_groups"
                            name="zixuan_groups"
                            lay-filter="select_zx_group"></select>
                        </label>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="add_zixuan"
                          class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                          <i class="layui-icon layui-icon-add-1"></i> è‡ªé€‰
                        </button>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="refresh_zixuan"
                          class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                          <i class="layui-icon layui-icon-refresh"></i>
                        </button>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="history_market_summary_btn"
                          class="layui-btn layui-btn-primary layui-border-blue layui-btn-sm"
                          onclick="window.open('/market_summary', '_blank')">
                          <i class="layui-icon layui-icon-chart"></i> å†å²æŠ¥å‘Š
                        </button>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">

                      </div>
                    </div>
                  </div>
                </form>
                <div
                  style="
                    overflow-y: auto;
                    height: calc(100% - 50px);
                    margin-top: 5px;
                  ">
                  <table
                    class="layui-hide"
                    id="table_zixuan_list"
                    style="width: 100%"></table>
                </div>
                <hr class="layui-border-red" />
              </div>
            </div>

            <div class="layui-colla-item">
              <div class="layui-colla-title" data-ca-title="ç›‘æ§æé†’">
                ç›‘æ§æé†’
              </div>
              <div class="layui-colla-content" style="padding: 0">
                <form
                  class="layui-form"
                  lay-filter="alert_records_form"
                  style="padding: 10px 10px 0 10px">
                  <div class="layui-form-item">
                    <label class="layui-form-label">ä»»åŠ¡åç§°</label>
                    <div class="layui-input-block">
                      <select
                        name="task_name_select"
                        id="task_name_select"
                        lay-filter="task_name_select">
                        <option value="">å…¨éƒ¨</option>
                      </select>
                    </div>
                  </div>
                </form>
                <table
                  class="layui-hide"
                  id="table_alert_reocrds"
                  lay-filter="table_alert_reocrds"></table>
                <hr class="layui-border-red" />
              </div>
            </div>
            <div class="layui-colla-item" id="collapse-bkgn">
              <div class="layui-colla-title" data-ca-title="æ¿å—æ¦‚å¿µ">
                æ¿å—æ¦‚å¿µ
              </div>
              <div class="layui-colla-content" style="padding: 0">
                <form
                  class="layui-form"
                  lay-filter="bkgn_form"
                  style="padding: 10px 10px 0 10px">
                  <div class="layui-form-item" style="margin-bottom: 5px">
                    <div class="layui-input-inline" style="width: 100%">
                      <div id="bkgn_xm_select"></div>
                    </div>
                  </div>
                </form>
                <div style="padding: 10px">
                  <table
                    class="layui-hide"
                    id="bkgn_table"
                    lay-filter="bkgn_table"
                    style="width: 100%; display: none"></table>
                </div>
                <hr class="layui-border-red" />
              </div>
            </div>
            <div class="layui-colla-item">
              <div class="layui-colla-title" data-ca-title="AIåˆ†æåŠ©æ‰‹">
                AIåˆ†æåŠ©æ‰‹
              </div>
              <div class="layui-colla-content" style="padding: 0">
                <form class="layui-form" style="width: 100%">
                  <div class="layui-form-item">
                    <div class="layui-inline">
                      <div
                        class="layui-input-inline layui-input-wrap"
                        style="width: 40%; float: left">
                        <label for="ai_code">
                          <input
                            type="text"
                            name="ai_code"
                            id="ai_code"
                            autocomplete="off"
                            readonly="readonly"
                            class="layui-input" />
                        </label>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="width: 30%; padding: 0 !important; float: left">
                        <label>
                          <select
                            name="ai_frequencys"
                            id="ai_frequencys"></select>
                        </label>
                      </div>
                      <div
                        class="layui-form-mid"
                        style="padding: 4px 0 !important; float: left">
                        <button
                          type="button"
                          id="ai_analyse_btn"
                          class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                          åˆ†æ
                        </button>
                      </div>
                    </div>
                  </div>
                </form>
                <table
                  class="layui-hide"
                  id="table_ai_analysis"
                  lay-filter="table_ai_analysis"></table>

                <hr class="layui-border-red" />
              </div>
            </div>
            <div class="layui-colla-item">
              <div class="layui-colla-title" data-ca-title="å…³äº">å…³äº</div>
              <div class="layui-colla-content" style="padding: 0">
                <div class="layui-text" style="padding: 16px">
                  <h3>Chanlun-Pro</h3>
                  <p>åŸºäºç¼ è®ºçš„å¸‚åœºè¡Œæƒ…é‡åŒ–åˆ†æå·¥å…·</p>
                  <p>
                    <a
                      href="https://github.com/yijixiuxin/chanlun-pro"
                      target="_blank"
                      >Github åœ°å€</a
                    >
                    <a
                      href="https://gitee.com/wang-student/chanlun-pro"
                      target="_blank"
                      >Gitee åœ°å€</a
                    >
                  </p>
                  <p>
                    é¡¹ç›®æ–‡æ¡£ï¼š<a
                      href="https://chanlun-pro.readthedocs.io/"
                      target="_blank"
                      >é“¾æ¥</a
                    >
                  </p>
                  <p>
                    é¡¹ç›®ä½œè€…<br />
                    <img
                      src="{{ url_for('static', filename='imgs/wx.jpg') }}"
                      width="200px"
                      height="260px"
                      alt="" />
                  </p>
                </div>

                <hr class="layui-border-red" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- æ–°é—»èµ„è®¯åŒºåŸŸ - å ç”¨å±å¹•åº•éƒ¨1/4 -->
      <div class="layui-row" style="flex: 1; min-height: 0; background-color: #f8f8f8; border-top: 1px solid #e6e6e6;">
        <div class="layui-col-xs12" style="height: 100%; padding: 10px;">
          <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h3 id="news_section_title" style="margin: 0; color: #333;">æ–°é—»èµ„è®¯</h3>
              <div style="display: flex; gap: 8px;">
                <button
                  type="button"
                  id="market_summary_btn"
                  class="layui-btn layui-btn-normal layui-btn-sm">
                  <i class="layui-icon layui-icon-chart"></i> å¸‚åœºæ€»ç»“
                </button>
                <button
                  type="button"
                  id="refresh_news"
                  class="layui-btn layui-btn-primary layui-border-red layui-btn-sm">
                  <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°æ–°é—»
                </button>
              </div>
            </div>
            <div
              id="news_list"
              style="
                flex: 1;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #e6e6e6;
                border-radius: 4px;
                padding: 15px;
              ">
              <!-- æ–°é—»åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
              <div class="layui-text" style="text-align: center; color: #999; padding: 20px;">
                ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ–°é—»
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% include 'sub_temp.html' %}
  </body>
  <script>
    // å®šæ—¶æ›´æ–°tickæ¶¨è·Œå¹…çš„å¯¹è±¡
    var interval_update_rates;
    var interval_get_alert_records;

    var market_frequencys = `{{ market_frequencys| tojson }}`;
    // è§£æ json å­—ç¬¦ä¸²
    var market_frequencys = JSON.parse(market_frequencys);

    var default_vals = {
      theme: "Light",
      market: "a",
      a_interval_1: "1D",
      a_interval_2: "1D",
      hk_interval_1: "1D",
      hk_interval_2: "1D",
      us_interval_1: "1D",
      us_interval_2: "1D",
      fx_interval_1: "1D",
      fx_interval_2: "1D",
      futures_interval_1: "1D",
      futures_interval_2: "1D",
      ny_futures_interval_1: "1D",
      ny_futures_interval_2: "1D",
      currency_interval_1: "1D",
      currency_interval_2: "1D",
      currency_spot_interval_1: "1D",
      currency_spot_interval_2: "1D",
      chart_layout_type: "single",
      a_code: "{{ market_default_codes.a }}",
      hk_code: "{{ market_default_codes.hk }}",
      us_code: "{{ market_default_codes.us }}",
      fx_code: "{{ market_default_codes.fx }}",
      futures_code: "{{ market_default_codes.futures }}",
      ny_futures_code: "{{ market_default_codes.ny_futures }}",
      currency_code: "{{ market_default_codes.currency }}",
      currency_spot_code: "{{ market_default_codes.currency_spot }}",
    };
    

    var chart_widgets = [];

    // å˜æ›´å›¾è¡¨å±•ç¤ºçš„æ ‡çš„
    function change_chart_ticker(_market, _code) {
      var market = _market;
      var code = _code;
      console.log('code',code)
      Utils.set_local_data("market", market);
      Utils.set_local_data(market + "_code", code);
      layui.each(chart_widgets, function (i, w) {
        w.activeChart().setSymbol(market + ":" + code);
      });
      ZiXuan.render_zixuan_opts();
      
      // æ ¹æ®è‚¡ç¥¨ä»£ç æœç´¢ç›¸å…³æ–°é—»
      search_news_by_code(market, code);
    }
    
    // æ ¹æ®è‚¡ç¥¨ä»£ç æœç´¢ç›¸å…³æ–°é—»
    function search_news_by_code(market, code) {
      // æ„å»ºæœç´¢æŸ¥è¯¢ï¼ŒåŒ…å«è‚¡ç¥¨ä»£ç å’Œå¸‚åœºä¿¡æ¯
      var searchQuery = code;
      if (market === 'a') {
        searchQuery += ' è‚¡ç¥¨ Aè‚¡';
      } else if (market === 'hk') {
        searchQuery += ' æ¸¯è‚¡ é¦™æ¸¯';
      } else if (market === 'us') {
        searchQuery += ' ç¾è‚¡ ç¾å›½';
      } else if (market === 'currency') {
        searchQuery += ' å¤–æ±‡ æ±‡ç‡';
      } else if (market === 'futures') {
        searchQuery += ' æœŸè´§';
      }
      
      console.log('æœç´¢ç›¸å…³æ–°é—»:', searchQuery);
      
      // å‘é€è¯­ä¹‰æœç´¢è¯·æ±‚
      $.ajax({
        url: '/api/news/semantic_search',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          query: searchQuery,
          n_results: 50,
          filters: {
            market_relevance: {"$gte": 0.3}  // åªæ˜¾ç¤ºå¸‚åœºç›¸å…³åº¦è¾ƒé«˜çš„æ–°é—»
          }
        }),
        success: function(response) {
           console.log('æ–°é—»æœç´¢ç»“æœ:', response);
           if (response.code === 0 && response.data && response.data.results && response.data.results.length > 0) {
             // è½¬æ¢æœç´¢ç»“æœæ ¼å¼ä»¥åŒ¹é…render_news_listæœŸæœ›çš„æ•°æ®ç»“æ„
             var formattedNews = response.data.results.map(function(item) {
               var metadata = item.metadata || {};
               return {
                 news_id: metadata.news_id || item.id,
                 title: metadata.title || 'æ— æ ‡é¢˜',
                 published_at: metadata.published_at || metadata.timestamp,
                 source: metadata.source || 'æœªçŸ¥æ¥æº',
                 body: item.document || metadata.body || ''
               };
             });
             
             // æ¸²æŸ“æœç´¢åˆ°çš„æ–°é—»
             News.render_news_list(formattedNews);
             // æ›´æ–°æ–°é—»åŒºåŸŸæ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰æœç´¢çš„è‚¡ç¥¨
             $('#news_section_title').text('æ–°é—»èµ„è®¯ - ' + code + ' ç›¸å…³');
           } else {
             console.log('æœªæ‰¾åˆ°ç›¸å…³æ–°é—»ï¼ŒåŠ è½½é»˜è®¤æ–°é—»');
             // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–°é—»ï¼ŒåŠ è½½é»˜è®¤æ–°é—»
             News.load_news();
             $('#news_section_title').text('æ–°é—»èµ„è®¯');
           }
         },
        error: function(xhr, status, error) {
          console.error('æœç´¢æ–°é—»å¤±è´¥:', error);
          // æœç´¢å¤±è´¥æ—¶åŠ è½½é»˜è®¤æ–°é—»
          News.load_news();
          $('#news_section_title').text('æ–°é—»èµ„è®¯');
        }
      });
    }
  </script>
  <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/chart_idx.js') }}"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
  <script src="{{ url_for('static', filename='js/zixuan.js') }}"></script>
  <script src="{{ url_for('static', filename='js/alert.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bkgn.js') }}"></script>
  <script>
    $(function () {
      // å¤„ç†URLå‚æ•°
      function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const market = urlParams.get('market');
        const code = urlParams.get('code');
        
        if (market && code) {
          console.log('URLå‚æ•°æ£€æµ‹åˆ°:', 'market=' + market, 'code=' + code);
          // è®¾ç½®å¸‚åœºå’Œä»£ç åˆ°localStorage
          Utils.set_local_data('market', market);
          Utils.set_local_data(market + '_code', code);
          
          // æ›´æ–°è¡¨å•é€‰æ‹©
          setTimeout(function() {
            layui.use('form', function() {
              var form = layui.form;
              form.val('select_market_form', {
                market: market
              });
            });
          }, 100);
        }
      }
      
      // é¡µé¢åŠ è½½æ—¶å¤„ç†URLå‚æ•°
      handleUrlParams();
      
      // ç¼ è®ºé…ç½®é¡¹æ›´æ”¹
      layui.use(function () {
        var layer = layui.layer;
        var element = layui.element;
        var form = layui.form;
        var util = layui.util;
        var dropdown = layui.dropdown;

        // ä¸‹æ‹‰èœå•äº‹ä»¶
        dropdown.render({
          elem: "#toggle-menu",
          data: [
            {
              title: "ç¼ è®ºé…ç½®é¡¹",
              templet:
                '<div><i class="layui-icon layui-icon-set"></i> <span>ç¼ è®ºé…ç½®é¡¹</span></div>',
              id: 1,
            },
            {
              title: "è‡ªé€‰ç»„ç®¡ç†",
              templet:
                '<div><i class="layui-icon layui-icon-templeate-1"></i> <span>è‡ªé€‰ç»„ç®¡ç†</span></div>',
              id: 2,
            },
            {
              title: "ç›‘æ§åˆ—è¡¨",
              templet:
                '<div><i class="layui-icon layui-icon-list"></i> <span>ç›‘æ§åˆ—è¡¨</span></div>',
              id: 3,
            },
            {
              title: "æ–°å¢ç›‘æ§",
              templet:
                '<div><i class="layui-icon layui-icon-speaker"></i> <span>æ–°å¢ç›‘æ§</span></div>',
              id: 4,
            },
            {
              title: "å½“å‰ä»»åŠ¡",
              templet:
                '<div><i class="layui-icon layui-icon-senior"></i> <span>å½“å‰ä»»åŠ¡</span></div>',
              id: 6,
            },
            {
              title: "åˆ‡æ¢å›¾è¡¨å¸ƒå±€",
              templet:
                '<div><i class="layui-icon layui-icon-carousel"></i> <span>åˆ‡æ¢å›¾è¡¨å¸ƒå±€</span></div>',
              id: 7,
              child: [
                {
                  title: "å¸ƒå±€-å•å›¾",
                  id: "single",
                },
                {
                  title: "å¸ƒå±€-æ¨ªå‘åŒå›¾",
                  id: "horizontal-2",
                },
                {
                  title: "å¸ƒå±€-æ¨ªå‘7/3",
                  id: "horizontal-7-3",
                },
                {
                  title: "å¸ƒå±€-çºµå‘åŒå›¾",
                  id: "vertical-2",
                },
                {
                  title: "å¸ƒå±€-ä¸‰å›¾",
                  id: "three",
                },
                {
                  title: "å¸ƒå±€-å››å›¾",
                  id: "four",
                },
              ],
            },
            {
              title: "åˆ‡æ¢ä¸»é¢˜",
              templet:
                '<div><i class="layui-icon layui-icon-engine"></i> <span>åˆ‡æ¢ä¸»é¢˜</span></div>',
              id: 8,
            },
          ],
          click: function (item) {
            if (item.title === "ç¼ è®ºé…ç½®é¡¹") {
              layer.open({
                type: 2,
                title: "ç¼ è®ºé…ç½®é¡¹å˜æ›´",
                area: ["1100px", "90vh"],
                content:
                  "/get_cl_config/" +
                  Utils.get_market() +
                  "/" +
                  Utils.get_code().replace("/", "__"),
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
              });
            } else if (item.title === "è‡ªé€‰ç»„ç®¡ç†") {
              layer.open({
                type: 2,
                title: "è‡ªé€‰ç»„ç®¡ç†",
                area: ["800px", "50vh"],
                content: "/zixuan_group/" + Utils.get_market(),
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
              });
            } else if (item.title === "ç›‘æ§åˆ—è¡¨") {
              layer.open({
                type: 1,
                title: "ç›‘æ§åˆ—è¡¨",
                area: ["1000px", "50vh"],
                content: $("#layer-wrapper-alert-task-list"),
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
                btn: ["åˆ·æ–°"],
                btn1: function (index, layero, that) {
                  Alert.refresh_alerts_table();
                },
                success: function (layero, index, that) {
                  // åˆå§‹æ¸²æŸ“è¡¨æ ¼
                  if (typeof Alert.refresh_alerts_table === "function") {
                    Alert.refresh_alerts_table();
                  }
                },
                end: function () {
                  $("#layer-wrapper-alert-task-list").hide();
                },
              });
            } else if (item.title === "æ–°å¢ç›‘æ§") {
              layer.open({
                type: 2,
                title: "æ–°å¢ç›‘æ§æé†’",
                area: ["1000px", "90vh"],
                content: "/alert_edit/" + Utils.get_market() + "/0",
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
              });
            } else if (item.title === "è¿è¡Œé€‰è‚¡") {
              layer.open({
                type: 2,
                title: "è¿è¡Œé€‰è‚¡",
                area: ["1000px", "50vh"],
                content: "/xuangu/task_list/" + Utils.get_market(),
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
              });
            } else if (item.title === "å½“å‰ä»»åŠ¡") {
              layer.open({
                type: 2,
                title: "å½“å‰ä»»åŠ¡",
                area: ["1000px", "50vh"],
                content: "/jobs",
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
              });
            } else if (item.title.startsWith("å¸ƒå±€-")) {
              Utils.set_local_data("chart_layout_type", item.id);
              location.reload();
            } else if (item.title === "åˆ‡æ¢ä¸»é¢˜") {
              let theme = Utils.get_local_data("theme");
              if (theme === "Light") {
                Utils.set_local_data("theme", "dark");
              } else {
                Utils.set_local_data("theme", "Light");
              }
              location.reload();
            } else if (item.title === "ç³»ç»Ÿè®¾ç½®") {
              layer.open({
                type: 2,
                title: "ç³»ç»Ÿè®¾ç½®",
                area: ["1000px", "50vh"],
                content: "/setting",
                anim: 1,
                fixed: true, // ä¸å›ºå®š
                shadeClose: true,
              });
            }
          },
        });

        // è‡ªé€‰æ“ä½œåˆå§‹
        ZiXuan.init_zixuan_opts();

        // æŠ˜å é¢æ¿äº‹ä»¶
        element.on("collapse(collapse-opts)", function (data) {
          let is_open = data.show; // å¾—åˆ°å½“å‰é¢æ¿çš„å±•å¼€çŠ¶æ€ï¼Œtrue or false
          let ca_title = $(data.title).attr("data-ca-title"); // å¾—åˆ°å½“å‰ç‚¹å‡»é¢æ¿çš„æ ‡é¢˜åŒºåŸŸå¯¹è±¡

          if (ca_title === "è‡ªé€‰ç»„") {
            if (is_open) {
              interval_update_rates = setInterval(
                ZiXuan.stocks_update_rate(),
                30000
              );
            } else {
              clearInterval(interval_update_rates);
            }
          }
          if (ca_title === "ç›‘æ§æé†’") {
            if (is_open) {
              Alert.init();
              // è·å–è­¦æŠ¥è®°å½•
              Alert.get_alert_records();
              interval_get_alert_records = setInterval(
                Alert.get_alert_records,
                60000
              );
            } else {
              clearInterval(interval_get_alert_records);
            }
          }



          if (ca_title === "æ¿å—æ¦‚å¿µ") {
            if (is_open) {
              // æ¿å—æ¦‚å¿µ
              BKGN.init_bkgn_opts();
            }
          }
        });

        // åˆå§‹èµ‹å€¼
        form.val("select_market_form", {
          market: Utils.get_market(),
        });
        // è¡¨å•å˜åŠ¨
        form.on("select(select_market)", function (data) {
          var market = data.value;
          Utils.set_local_data("market", market);
          // ä¿æŒURLå‚æ•°è¿›è¡Œåˆ·æ–°
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('market') || urlParams.has('code')) {
            urlParams.set('market', market);
            window.location.href = window.location.pathname + '?' + urlParams.toString();
          } else {
            location.reload();
          }
        });

        // å›ºå®šæ¡ï¼Œæ˜¾ç¤ºä¸éšè—èœå•æ 
        Utils.render_fixbar();

        // AI åˆ†æåŠ©æ‰‹
        AI.init_ai_opts();
        AI.get_ai_analyse_records();

        // æ–°é—»æ¨¡å—åˆå§‹åŒ–
        News.init();
        // è‡ªåŠ¨åŠ è½½æ–°é—»æ•°æ®
        News.load_news();
      });

      // åˆå§‹åŒ–å±•ç¤ºé¡µé¢
      function init_web() {
        // å¦‚æœå¸‚åœºä¸æ˜¯ aï¼Œåˆ™éšè— collapse-bkgn
        if (Utils.get_market() !== "a") {
          $("#collapse-bkgn").hide();
        }

        let chart_layout_type =
          Utils.get_local_data("chart_layout_type") || "single";
        let charts_area = $("#tv_charts_area");
        charts_area.empty();
        let win_height = window.innerHeight;
        let win_width = charts_area.width() || window.innerWidth;
        let chart_configs = [];
        if (chart_layout_type === "single") {
          chart_configs = [{ id: "1", style: "flex:1;" }];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "vertical-2") {
          chart_configs = [
            { id: "1", style: "flex:1;" },
            { id: "2", style: "flex:1;" },
          ];
          charts_area.css({ display: "flex", flexDirection: "row" });
        } else if (chart_layout_type === "horizontal-2") {
          chart_configs = [
            { id: "1", style: "flex:1;" },
            { id: "2", style: "flex:1;" },
          ];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "three") {
          chart_configs = [{ id: "1" }, { id: "2" }, { id: "3" }];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "horizontal-7-3") {
          chart_configs = [{ id: "1" }, { id: "2" }];
          charts_area.css({ display: "flex", flexDirection: "column" });
        } else if (chart_layout_type === "four") {
          chart_configs = [
            { id: "1", style: "width:50%;height:50%;float:left;" },
            { id: "2", style: "width:50%;height:50%;float:left;" },
            { id: "3", style: "width:50%;height:50%;float:left;" },
            { id: "4", style: "width:50%;height:50%;float:left;" },
          ];
          charts_area.css({
            display: "flex",
            flexDirection: "row",
            flexWrap: "wrap",
          });
        }

        chart_widgets = [];
        if (chart_layout_type === "horizontal-7-3") {
          charts_area.append(
            '<div id="tv_chart_container_1" style="width:100%;height:' +
              win_height * 0.7 +
              'px;"></div>'
          );
          charts_area.append(
            '<div id="tv_chart_container_2" style="width:100%;height:' +
              win_height * 0.3 +
              'px;"></div>'
          );
          chart_widgets.push(Charts.show_tv_chart("1", win_height * 0.7));
          chart_widgets.push(Charts.show_tv_chart("2", win_height * 0.3));
        } else if (chart_layout_type === "three") {
          // ä¸Šé¢ä¸€è¡Œä¸¤ä¸ªå›¾
          let rowDiv = $(
            '<div style="display:flex;width:100%;height:' +
              win_height / 2 +
              'px;"></div>'
          );
          rowDiv.append(
            '<div id="tv_chart_container_1" style="flex:1;"></div>'
          );
          rowDiv.append(
            '<div id="tv_chart_container_2" style="flex:1;"></div>'
          );
          charts_area.append(rowDiv);
          // ä¸‹é¢ä¸€è¡Œä¸€ä¸ªå›¾
          charts_area.append(
            '<div id="tv_chart_container_3" style="width:100%;height:' +
              win_height / 2 +
              'px;"></div>'
          );
          chart_widgets.push(Charts.show_tv_chart("1", win_height / 2));
          chart_widgets.push(Charts.show_tv_chart("2", win_height / 2));
          chart_widgets.push(Charts.show_tv_chart("3", win_height / 2));
        } else {
          chart_configs.forEach(function (cfg, idx) {
            let div_id = "tv_chart_container_" + cfg.id;
            charts_area.append(
              '<div id="' +
                div_id +
                '" style="' +
                (cfg.style || "") +
                '"></div>'
            );
            // è®¡ç®—æ¯ä¸ªå›¾è¡¨çš„é«˜åº¦/å®½åº¦
            let chart_height =
              chart_layout_type === "single"
                ? win_height
                : chart_layout_type === "vertical-2" ||
                  chart_layout_type === "horizontal-2"
                ? win_height / 2
                : chart_layout_type === "four"
                ? win_height / 2
                : win_height;
            chart_widgets.push(Charts.show_tv_chart(cfg.id, chart_height));
          });
        }
        ZiXuan.render_zixuan_opts();
      }

      init_web();
      interval_update_rates = setInterval(ZiXuan.stocks_update_rate(), 30000);
    });

    // æ–°é—»æ¨¡å—å¯¹è±¡ï¼ˆç§»åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.News = {
      // åˆå§‹åŒ–
      init: function() {
        var self = this;
        // ç»‘å®šåˆ·æ–°æŒ‰é’®äº‹ä»¶
        $('#refresh_news').click(function() {
          self.load_news();
        });
        
        // ç»‘å®šå¸‚åœºæ€»ç»“æŒ‰é’®äº‹ä»¶
        $('#market_summary_btn').click(function() {
          self.generate_market_summary();
        });
      },

      // åŠ è½½æ–°é—»æ•°æ®
      load_news: function() {
        var self = this;
        var newsContainer = $('#news_list');
        
        // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
        newsContainer.html('<div class="layui-text" style="text-align: center; color: #999; padding: 20px;"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> åŠ è½½ä¸­...</div>');
        
        // å‘é€AJAXè¯·æ±‚è·å–æ–°é—»æ•°æ®
        $.ajax({
          url: '/api/news',
          type: 'GET',
          data: {
            limit: 20,
            offset: 0
          },
          success: function(response) {
            if (response.code === 0 && response.data && response.data.news_list) {
              self.render_news_list(response.data.news_list);
            } else {
              newsContainer.html('<div class="layui-text" style="text-align: center; color: #ff5722; padding: 20px;">åŠ è½½æ–°é—»å¤±è´¥: ' + (response.msg || 'æœªçŸ¥é”™è¯¯') + '</div>');
            }
          },
          error: function(xhr, status, error) {
            newsContainer.html('<div class="layui-text" style="text-align: center; color: #ff5722; padding: 20px;">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>');
          }
        });
      },

      // æ¸²æŸ“æ–°é—»åˆ—è¡¨
      render_news_list: function(newsList) {
        var self = this;
        var newsContainer = $('#news_list');
        var html = '';
        
        // å­˜å‚¨å½“å‰æ–°é—»åˆ—è¡¨æ•°æ®
        this.currentNewsList = newsList;
        
        if (newsList.length === 0) {
          html = '<div class="layui-text" style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ–°é—»æ•°æ®</div>';
        } else {
          newsList.forEach(function(news) {
            // var publishTime = news.published_at ? new Date(news.published_at).toLocaleString('zh-CN', {
            //   month: '2-digit',
            //   day: '2-digit',
            //   hour: '2-digit',
            //   minute: '2-digit'
            // }) : 'æœªçŸ¥æ—¶é—´';
            publishTime =news.published_at.replace('T',' ').replace('Z','');
            html += '<div class="news-item" style="margin-bottom: 10px; padding: 8px; border: 1px solid #e6e6e6; border-radius: 4px; cursor: pointer;" data-news-id="' + news.news_id + '">';
            html += '<div class="news-title" style="font-size: 12px; font-weight: bold; color: #333; margin-bottom: 4px; line-height: 1.4;" title="' + news.title + '">' + (news.title.length > 50 ? news.title.substring(0, 50) + '...' : news.title) + '</div>';
            html += '<div class="news-meta" style="font-size: 10px; color: #999;">';
            html += '<span class="news-time">' + publishTime + '</span>';
            if (news.source) {
              html += ' | <span class="news-source">' + news.source + '</span>';
            }
            html += '</div>';
            html += '</div>';
          });
        }
        
        newsContainer.html(html);
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šæ–°é—»é¡¹ç‚¹å‡»äº‹ä»¶
        newsContainer.off('click', '.news-item').on('click', '.news-item', function() {
          var newsId = $(this).data('news-id');
          console.log('News item clicked, ID:', newsId);
          if (self.show_news_detail) {
            self.show_news_detail(newsId);
          } else {
            console.error('News.show_news_detail function not found');
          }
        });
      },

      // å­˜å‚¨å½“å‰æ–°é—»åˆ—è¡¨æ•°æ®
      currentNewsList: [],
      
      // æ˜¾ç¤ºæ–°é—»è¯¦æƒ…
      show_news_detail: function(newsId) {
        console.log('show_news_detail called with newsId:', newsId);
        
        // é¦–å…ˆå°è¯•ä»å½“å‰æ–°é—»åˆ—è¡¨ä¸­æŸ¥æ‰¾
        var news = this.currentNewsList.find(function(item) {
          return item.news_id === String(newsId) || item.news_id === newsId || item.id === parseInt(newsId) || item.story_id === newsId;
        });
        
        if (news) {
          console.log('Found news in current list:', news);
          this.display_news_detail(news);
        } else {
          console.log('News not found in current list, fetching from API');
          // å¦‚æœå½“å‰åˆ—è¡¨ä¸­æ²¡æœ‰ï¼Œåˆ™ä»APIè·å–
          $.ajax({
            url: '/api/news',
            type: 'GET',
            data: {
              limit: 100,
              offset: 0
            },
            success: function(response) {
              console.log('News detail AJAX success:', response);
              if (response.code === 0 && response.data && response.data.news_list) {
                var foundNews = response.data.news_list.find(function(item) {
                  return item.news_id === String(newsId) || item.news_id === newsId || item.id === parseInt(newsId) || item.story_id === newsId;
                });
                
                if (foundNews) {
                  window.News.display_news_detail(foundNews);
                } else {
                  layui.layer.msg('æœªæ‰¾åˆ°æ–°é—»è¯¦æƒ…');
                }
              } else {
                layui.layer.msg('è·å–æ–°é—»è¯¦æƒ…å¤±è´¥');
              }
            },
            error: function(xhr, status, error) {
              console.error('News detail AJAX error:', error);
              layui.layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
          });
        }
      },
      
      // æ˜¾ç¤ºæ–°é—»è¯¦æƒ…å¼¹çª—
      display_news_detail: function(news) {
        var publishTime = news.published_at ? new Date(news.published_at).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
        var content = '<div style="padding: 20px;">';
        content += '<h3 style="margin-bottom: 15px; color: #333;">' + news.title + '</h3>';
        content += '<div style="margin-bottom: 15px; color: #666; font-size: 12px;">';
        content += '<span>å‘å¸ƒæ—¶é—´: ' + publishTime + '</span>';
        if (news.source) {
          content += ' | <span>æ¥æº: ' + news.source + '</span>';
        }
        content += '</div>';
        content += '<div style="line-height: 1.6; color: #333;">' + (news.body || 'æš‚æ— æ­£æ–‡å†…å®¹') + '</div>';
        content += '</div>';
        
        layui.layer.open({
          type: 1,
          title: 'æ–°é—»è¯¦æƒ…',
          area: ['80%', '80%'],
          content: content,
          shadeClose: true,
          maxmin: true
        });
      },
      
      // ç”Ÿæˆå¸‚åœºæ€»ç»“
      generate_market_summary: function() {
        var self = this;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°é—»æ•°æ®
        if (!this.currentNewsList || this.currentNewsList.length === 0) {
          layui.layer.msg('è¯·å…ˆåŠ è½½æ–°é—»æ•°æ®');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        var loadingIndex = layui.layer.load(1, {
          content: 'æ­£åœ¨ç”Ÿæˆå¸‚åœºæ€»ç»“ï¼Œè¯·ç¨å€™...',
          success: function(layero) {
            layero.find('.layui-layer-content').css({
              'padding-top': '40px',
              'width': '200px'
            });
          }
        });
        
        // è·å–å½“å‰æ ‡çš„ä¿¡æ¯
        var currentMarket = Utils.get_market();
        var currentCode = Utils.get_code();
        
        // å‘é€è¯·æ±‚ç”Ÿæˆå¸‚åœºæ€»ç»“
        $.ajax({
          url: '/api/news/market_summary',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            news_list: this.currentNewsList,
            current_market: currentMarket,
            current_code: currentCode
          }),
          success: function(response) {
            layui.layer.close(loadingIndex);
            
            if (response.code === 0 && response.data && response.data.summary) {
              self.show_market_summary(response.data.summary);
            } else {
              layui.layer.msg('ç”Ÿæˆå¸‚åœºæ€»ç»“å¤±è´¥: ' + (response.msg || 'æœªçŸ¥é”™è¯¯'));
            }
          },
          error: function(xhr, status, error) {
            layui.layer.close(loadingIndex);
            layui.layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
          }
        });
      },
      
      // æ˜¾ç¤ºå¸‚åœºæ€»ç»“å¼¹çª—
      show_market_summary: function(summary) {
        var currentDate = new Date().toLocaleDateString('zh-CN');
        var content = '<div style="padding: 20px;">';
        content += '<div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #333;">ğŸ“Š ' + currentDate + ' å¸‚åœºæ€»ç»“</h4>';
        content += '<p style="margin: 0; color: #666; font-size: 12px;">åŸºäºå½“å‰æ–°é—»æ•°æ®ï¼Œç”±AIå¤§æ¨¡å‹ç”Ÿæˆ</p>';
        content += '</div>';
        // ä½¿ç”¨marked.jså°†Markdownè½¬æ¢ä¸ºHTML
        var htmlContent = marked.parse ? marked.parse(summary) : (marked(summary) || summary);
        content += '<div style="line-height: 1.8; color: #333;">' + htmlContent + '</div>';
        content += '</div>';
        
        layui.layer.open({
          type: 1,
          title: 'å¸‚åœºæ€»ç»“',
          area: ['85%', '85%'],
          content: content,
          shadeClose: true,
          maxmin: true,
          btn: ['å…³é—­'],
          btnAlign: 'c'
        });
      }
    };
  </script>
</html>
